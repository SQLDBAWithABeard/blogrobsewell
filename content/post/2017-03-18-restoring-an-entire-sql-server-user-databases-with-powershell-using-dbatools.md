---
title: "Restoring an entire SQL Server user databases with PowerShell using dbatools"
date: "2017-03-18" 
categories:
  - Blog

tags:
  - backup
  - dbatools
  - restore

---
<P>All the good DBAs backup their databases.</P>
<P>A significant amount of SQL DBAs use <A href="https://ola.hallengren.com/" rel=noopener target=_blank>Ola Hallengrens maintenance solution</A> to do so.</P>
<P>This gives a folder structure like this</P>
<P><IMG class="alignnone size-full wp-image-3789" alt="01 - folder structure.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/01-folder-structure.png?resize=630%2C445&amp;ssl=1" width=630 height=445 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/01-folder-structure.png?fit=630%2C445&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/01-folder-structure.png?fit=300%2C212&amp;ssl=1" data-image-description="" data-image-title="01 – folder structure" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="718,507" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/01-folder-structure.png?fit=718%2C507&amp;ssl=1" data-permalink="https://blog.robsewell.com/restoring-an-entire-sql-server-user-databases-with-powershell-using-dbatools/01-folder-structure/#main" data-attachment-id="3789"></P>
<P>&nbsp;</P>
<P>In my lab I had installed SQL 2016 on a server running Server 2016 TP5 which expired so I needed to re-install Windows and therefore needed to restore all of my user databases again. This was so easy using the <A href="https://dbatools.io" rel=noopener target=_blank>dbatools module </A>that I thought it was worth sharing to show how easy your disaster recovery process could be.</P>
<P>Having re-installed Windows and SQL and copied the backup files back to the server (although I could have used a network location), I then had to restore all of the user databases.</P>
<P>This is how I&nbsp;restored all of my user databases&nbsp;using the dbatools module command <A href="https://dbatools.io/functions/restore-sqlbackupfromdirectory/" rel=noopener target=_blank><SPAN style="COLOR: #0066cc">Restore-SQLBackupFromDirectory</SPAN></A></P><PRE class="lang:ps decode:true"> Restore-SqlBackupFromDirectory -SqlServer SQL2016N2 -Path '\\sql2016n2\c$\MSSQL\Backup\SQL2016N2'</PRE>
<P>Here it is in action</P>
<P><IMG class="alignnone size-full wp-image-3811" alt="02 - Restore in action.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/02-restore-in-action.png?resize=630%2C210&amp;ssl=1" width=630 height=210 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/02-restore-in-action.png?fit=630%2C210&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/02-restore-in-action.png?fit=300%2C100&amp;ssl=1" data-image-description="" data-image-title="02 – Restore in action" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="1284,427" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/02-restore-in-action.png?fit=1284%2C427&amp;ssl=1" data-permalink="https://blog.robsewell.com/restoring-an-entire-sql-server-user-databases-with-powershell-using-dbatools/02-restore-in-action/#main" data-attachment-id="3811"></P>
<P>This is the output</P>
<P><IMG class="alignnone size-full wp-image-3814" alt="03 - output.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/03-output.png?resize=630%2C556&amp;ssl=1" width=630 height=556 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/03-output.png?fit=630%2C556&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/03-output.png?fit=300%2C265&amp;ssl=1" data-image-description="" data-image-title="03 – output" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="914,806" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/03-output.png?fit=914%2C806&amp;ssl=1" data-permalink="https://blog.robsewell.com/restoring-an-entire-sql-server-user-databases-with-powershell-using-dbatools/03-output/#main" data-attachment-id="3814"></P>
<P>That’s it. As simple as that. An entire SQL Servers user databases restored in one line of code. The latest Full, Latest Diff and latest Log backups for each user database all restored to the default file and log location&nbsp;without issue</P>
<P>If you look at the help for the command using</P><PRE class="lang:ps decode:true"> Get-Help Restore-SqlBackupFromDirectory -ShowWindow</PRE>
<P>You will see that there is a -ReuseSourceFolderStructure switch which will use the file structure from the backup file if you have a complex file structure for your SQL files. You can also use a -NoRecovery switch so that you can add further backups, maybe you could use this for setting up mirroring or Always On Availability groups.</P>
<P>If you want to check the restore history of your SQL Server then you can use the <A href="https://dbatools.io/functions/Get-DbaRestoreHistory/" rel=noopener target=_blank>Get-DbaRestoreHistory</A>&nbsp; command. I like to use <A href="https://msdn.microsoft.com/en-us/powershell/reference/5.1/microsoft.powershell.utility/out-gridview" rel=noopener target=_blank>Out-GridView</A> as it enables you to filter and sort easily</P><PRE class="lang:ps decode:true"> Get-DbaRestoreHistory -SqlServer sql2016N2 | ogv</PRE>
<P>&nbsp;</P>
<P><A href="https://blog.robsewell.com/assets/uploads/2017/03/04-get-database-restore-history.png?ssl=1" rel=noopener target=_blank><IMG class="alignnone size-full wp-image-3835" alt="04 get-database restore history" src="https://blog.robsewell.com/assets/uploads/2017/03/04-get-database-restore-history.png?resize=630%2C277&amp;ssl=1" width=630 height=277 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/04-get-database-restore-history.png?fit=630%2C277&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/04-get-database-restore-history.png?fit=300%2C132&amp;ssl=1" data-image-description="" data-image-title="04 get-database restore history" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="1891,830" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/04-get-database-restore-history.png?fit=1891%2C830&amp;ssl=1" data-permalink="https://blog.robsewell.com/restoring-an-entire-sql-server-user-databases-with-powershell-using-dbatools/04-get-database-restore-history/#main" data-attachment-id="3835"></A></P>
<P>So you can see each file that was restored and where it was restored to</P>
<P>Happy Automating</P>
<P>&nbsp;</P>
<P>NOTE – The major 1.0 release of dbatools due in the summer 2017 may have breaking changes which will stop the above code from working. There are also new commands coming which may replace this command. This blog post was written using dbatools version 0.8.942 You can check your version using</P><PRE class="lang:ps decode:true"> Get-Module dbatools</PRE>
<P>and update it using an Administrator PowerShell session with</P><PRE class="lang:ps decode:true"> Update-Module dbatools</PRE>
<P>You may find that you get no output from Update-Module as you have the latest version. If&nbsp;you have not installed the&nbsp;module from the PowerShell Gallery using</P><PRE class="lang:ps decode:true">&amp;nbsp;Install-Module dbatools</PRE>
<P>Then you can use</P><PRE class="lang:ps decode:true">&amp;nbsp;Update-dbatools</PRE>
<P>&nbsp;</P>

