---
title: "Testing Your SQL Server Backups the Easy Way with PowerShell & dbatools"
date: "2017-03-20" 
categories:
  - Blog

tags:
  - automation
  - backups
  - dbatools
  - PowerShell
  - restore

---
<P>In a <A href="https://blog.robsewell.com/restoring-an-entire-sql-server-user-databases-with-powershell-using-dbatools/">previous post</A> I wrote about how easy it was to restore a whole SQL Servers user databases from a&nbsp; directory&nbsp;using the <A href="https://dbatools.io">dbatools module.</A> Maybe it is a good idea to look at for disaster recovery scenarios but&nbsp;even PowerShell is&nbsp;going to be useless if your backups don’t work</P>
<P>But setting up a solution to test your backups (technically test your restores) is difficult isn’t it?</P>
<P>Lets use the <A href="https://dbatools.io" rel=noopener target=_blank>dbatools module</A> and see how easy it is</P>
<P>The dbatools module has a command called <A href="https://dbatools.io/functions/Test-DbaLastBackup/" rel=noopener target=_blank>Test-DbaLastBackup </A>if you look at the page or at the help&nbsp;using</P>
<P>&nbsp;</P><PRE class="lang:ps decode:true">Get-Help Test-DbaLastBackup -ShowWindow</PRE>
<P>&nbsp;</P>
<P>you will see that this command</P>
<BLOCKQUOTE>
<P>Restores all or some of the latest backups and performs a&nbsp;consistency check</P>
<P>1. Gathers information about the last full backups<BR>2. Restores the backups to the Destination with a new name. If no Destination is specified, the originating SqlServer will be used.<BR>3. The database is restored as “dbatools-testrestore-$databaseName” by default, but you can change dbatools-testrestore to whatever you would like using -Prefix<BR>4. The internal file names are also renamed to prevent conflicts with original database<BR>5. A&nbsp;consistency check&nbsp;is then performed<BR>6. And the test database is finally dropped</P></BLOCKQUOTE>
<P>So, if you only have one SQL Server but want to ensure that&nbsp;you are testing your backup files then as along as you have the diskspace you can simply run</P><PRE class="lang:ps decode:true">Test-DbaLastBackup -SqlServer sql2016n2</PRE>
<P>and the latest backups that have been taken will be restored using a different name with different filenames, checked for consistency and then dropped</P>
<P><IMG class="alignnone size-full wp-image-3872" alt="01 - simple test backups.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/01-simple-test-backups.png?resize=630%2C570&amp;ssl=1" width=630 height=570 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/01-simple-test-backups.png?fit=630%2C570&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/01-simple-test-backups.png?fit=300%2C271&amp;ssl=1" data-image-description="" data-image-title="01 – simple test backups" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="744,673" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/01-simple-test-backups.png?fit=744%2C673&amp;ssl=1" data-permalink="https://blog.robsewell.com/testing-your-sql-server-backups-the-easy-way-with-powershell-dbatools/01-simple-test-backups/#main" data-attachment-id="3872"></P>
<P>and as you can see an object is returned<BR>SourceServer&nbsp; : SQL2016N2<BR>TestServer&nbsp;&nbsp;&nbsp; : SQL2016N2<BR>Database&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : FadetoBlack<BR>FileExists&nbsp;&nbsp;&nbsp; : True<BR>RestoreResult : Success<BR>DbccResult&nbsp;&nbsp;&nbsp; : Success<BR>SizeMB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 1243.26<BR>BackupTaken&nbsp;&nbsp; : 3/18/2017 12:36:07 PM<BR>BackupFiles&nbsp;&nbsp; : Z:\SQL2016N2\FadetoBlack\FULL_COPY_ONLY\SQL2016N2_FadetoBlack_FULL_COPY_ONLY_20170318_123607.bak</P>
<P>which shows the Server, the database, if the file exists, the restore result, the DBCC result, the size of the backup file, when it was taken and the path used</P>
<P>You don’t have to use the same server and in many shops you would not want to. You can specify a destination server and you can also pipe the results to Out-GridView to enable easy filtering.</P><PRE class="lang:ps decode:true">Test-DbaLastBackup -SqlServer sql2016n2 -Destination SQL2016N1 | OGV</PRE>
<P>Note you need to be backing up to a shared location ie a path that starts \\ I have fudged this a little in the demo for the keen eyed</P>
<P><IMG class="alignnone size-full wp-image-3887" alt="03 - with OGV.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/03-with-ogv.png?resize=630%2C343&amp;ssl=1" width=630 height=343 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/03-with-ogv.png?fit=630%2C343&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/03-with-ogv.png?fit=300%2C163&amp;ssl=1" data-image-description="" data-image-title="03 – with OGV" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="1239,674" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/03-with-ogv.png?fit=1239%2C674&amp;ssl=1" data-permalink="https://blog.robsewell.com/testing-your-sql-server-backups-the-easy-way-with-powershell-dbatools/03-with-ogv/#main" data-attachment-id="3887"></P>
<P>Maybe you only want to test the backups for the important databases or some backups are restored using other means and you don’t need to test them this way. There is a databases parameter which you can tab through the database names</P>
<P><IMG class="alignnone size-full wp-image-3890" alt="04 - choosing databases.gif" src="https://blog.robsewell.com/assets/uploads/2017/03/04-choosing-databases.gif?resize=630%2C178&amp;ssl=1" width=630 height=178 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/04-choosing-databases.gif?fit=630%2C178&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/04-choosing-databases.gif?fit=300%2C85&amp;ssl=1" data-image-description="" data-image-title="04 – choosing databases" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="1407,398" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/04-choosing-databases.gif?fit=1407%2C398&amp;ssl=1" data-permalink="https://blog.robsewell.com/testing-your-sql-server-backups-the-easy-way-with-powershell-dbatools/04-choosing-databases/#main" data-attachment-id="3890"></P>
<P>In the ISE you can see the drop down of database names</P>
<P><IMG class="alignnone size-full wp-image-3893" alt="05 - in ISE.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/05-in-ise.png?resize=630%2C155&amp;ssl=1" width=630 height=155 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/05-in-ise.png?fit=630%2C155&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/05-in-ise.png?fit=300%2C74&amp;ssl=1" data-image-description="" data-image-title="05 – in ISE" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="1832,450" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/05-in-ise.png?fit=1832%2C450&amp;ssl=1" data-permalink="https://blog.robsewell.com/testing-your-sql-server-backups-the-easy-way-with-powershell-dbatools/05-in-ise/#main" data-attachment-id="3893"></P>
<P>If you have limited space you might not want to test the largest databases so you can use the MaxMb parameter to only restore databases under this size. In the example below, you can see that Fadetoblack was skipped and the system databases were skipped as they are not backing up to a shared location</P>
<P><IMG class="alignnone size-full wp-image-3901" alt="06 - max mb.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/06-max-mb.png?resize=630%2C214&amp;ssl=1" width=630 height=214 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/06-max-mb.png?fit=630%2C214&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/06-max-mb.png?fit=300%2C102&amp;ssl=1" data-image-description="" data-image-title="06 – max mb" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="1519,516" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/06-max-mb.png?fit=1519%2C516&amp;ssl=1" data-permalink="https://blog.robsewell.com/testing-your-sql-server-backups-the-easy-way-with-powershell-dbatools/06-max-mb/#main" data-attachment-id="3901"></P>
<P>The databases are restored onto the server using a different name and the files are also named differently to avoid any conflicts. The default prefix is dbatools-testrestore- but you can change this using the prefix switch if you wish</P>
<P><IMG class="alignnone size-full wp-image-3904" alt="02 data files.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/02-data-files.png?resize=630%2C130&amp;ssl=1" width=630 height=130 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/02-data-files.png?fit=630%2C130&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/02-data-files.png?fit=300%2C62&amp;ssl=1" data-image-description="" data-image-title="02 data files" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="1222,253" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/02-data-files.png?fit=1222%2C253&amp;ssl=1" data-permalink="https://blog.robsewell.com/testing-your-sql-server-backups-the-easy-way-with-powershell-dbatools/02-data-files/#main" data-attachment-id="3904"></P>
<P>You may not want to use your special, super quick storage for performing your test restores. If you have separate data drives that you would like to use for the restores, you can specify those with the -DataDirectory and -LogDirectory. If you do not use these switches then the command will use the default data and log locations.</P>
<P>Its possible to reduce the amount of checks that are done. If you only want to do a Verify Only on the backup then you can use the -VerifyOnly switch, you can skip the DBCC check by using the -NoCheck switch and you can leave the test restore databases on the server using the -NoDrop switch</P>
<P>Happy Automating</P>
<P>&nbsp;</P>
<P>NOTE – The major 1.0 release of dbatools due in the summer 2017 may have breaking changes which will stop the above code from working. There are also new commands coming which may replace this command. This blog post was written using dbatools version 0.8.942 You can check your version using</P><PRE class="lang:ps decode:true"> Get-Module dbatools</PRE>
<P>and update it using an Administrator PowerShell session with</P><PRE class="lang:ps decode:true"> Update-Module dbatools</PRE>
<P>You may find that you get no output from Update-Module as you have the latest version. If&nbsp;you have not installed the&nbsp;module from the PowerShell Gallery using</P><PRE class="lang:ps decode:true">Install-Module dbatools</PRE>
<P>Then you can use</P><PRE class="lang:ps decode:true">Update-dbatools</PRE>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>

