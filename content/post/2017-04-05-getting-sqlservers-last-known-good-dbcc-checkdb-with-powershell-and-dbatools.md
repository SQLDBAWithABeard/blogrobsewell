---
title: "Getting SQLServers Last Known Good DBCC Checkdb with PowerShell and dbatools"
categories:
  - Blog

tags:
  - automate
  - automation
  - databases
  - dbatools
  - PowerShell

---
<P>As good SQL Server DBA‚Äôs we want to ensure that our databases are regularly checked for consistency by running DBCC CheckDB. This will be frequently scheduled using an Agent Job or by using <A href="https://ola.hallengren.com/" target=_blank>Ola Hallengrens Maintenance Solution</A></P>
<P>We can check for the last known good DBCC Check using the undocumented <B><SPAN style="COLOR: #6a6a6a">DBCC DBINFO</SPAN></B>(DBNAME) WITH TABLERESULTS You can see the last known good DBCC Check around about row 50</P>
<P><IMG class="alignnone size-full wp-image-4440" alt="00 - Using TSQL.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/00-using-tsql.png?resize=630%2C530&amp;ssl=1" width=630 height=530 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/00-using-tsql.png?fit=630%2C530&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/00-using-tsql.png?fit=300%2C252&amp;ssl=1" data-image-description="" data-image-title="00 ‚Äì Using TSQL" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="753,633" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/00-using-tsql.png?fit=753%2C633&amp;ssl=1" data-permalink="https://blog.robsewell.com/getting-sqlservers-last-known-good-dbcc-checkdb-with-powershell-and-dbatools/00-using-tsql/#main" data-attachment-id="4440"></P>
<P>This makes parsing the information a bit more tricky and whilst you could use sp_MSForEachDB&nbsp;to iterate through the databases that doesn‚Äôt always work as you expect as <A href="http://sqlblog.com/blogs/aaron_bertrand/archive/2010/12/29/a-more-reliable-and-more-flexible-sp-msforeachdb.aspx" target=_blank>Aaron Bertrand explains</A></P>
<P>Of course, I am going to use PowerShell and also the <A href="https://dbatools.io" target=_blank>dbatools module</A> This module is a community based project written by excellent, brilliant people in their own time and available to you free. To find out more and how to use and install it visit <A href="https://dbatools.io" target=_blank>https://dbatools.io</A></P>
<P>In the module there is a command called <A href="https://dbatools.io/functions/get-dbalastgoodcheckdb/" target=_blank>Get-DbaLastGoodCheckDb</A>&nbsp;This command was created by Jakob Bindslet. You can find Jakob on his <A href="http://mspowershell.blogspot.be/"><SPAN style="COLOR: #012456">blog</SPAN></A> and on <A href="https://dk.linkedin.com/in/jakobbindslet"><SPAN style="COLOR: #012456">LinkedIn</SPAN></A>.</P>
<P>As always, you start with any PowerShell command by using Get-Help</P><PRE class="lang:ps decode:true">get-help Get-DbaLastGoodCheckDb -ShowWindow</PRE>
<P><IMG class="alignnone size-full wp-image-4456" alt="00a - get help.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/00a-get-help.png?resize=630%2C478&amp;ssl=1" width=630 height=478 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/00a-get-help.png?fit=630%2C478&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/00a-get-help.png?fit=300%2C228&amp;ssl=1" data-image-description="" data-image-title="00a ‚Äì get help" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="821,623" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/00a-get-help.png?fit=821%2C623&amp;ssl=1" data-permalink="https://blog.robsewell.com/getting-sqlservers-last-known-good-dbcc-checkdb-with-powershell-and-dbatools/00a-get-help/#main" data-attachment-id="4456"></P>
<P>This command has three parameters Sqlserver, Credential and Detailed. Lets see what it looks like</P><PRE class="lang:ps decode:true">Get-DbaLastGoodCheckDb -SqlServer SQLvNextN2</PRE>
<P><IMG class="alignnone size-full wp-image-4461" alt="01 - One server" src="https://blog.robsewell.com/assets/uploads/2017/03/01-one-server.png?resize=506%2C183&amp;ssl=1" width=506 height=183 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/01-one-server.png?fit=506%2C183&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/01-one-server.png?fit=300%2C108&amp;ssl=1" data-image-description="" data-image-title="01 ‚Äì One server" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="506,183" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/01-one-server.png?fit=506%2C183&amp;ssl=1" data-permalink="https://blog.robsewell.com/getting-sqlservers-last-known-good-dbcc-checkdb-with-powershell-and-dbatools/01-one-server/#main" data-attachment-id="4461"></P>
<P>It returns an object with the server name, database name and the time and date of the last known good checkdb for every database on the server. What happens if we use the detailed parameter?</P><PRE class="lang:ps decode:true">Get-DbaLastGoodCheckDb -SqlServer SQLvNextN2 -Detailed</PRE>
<P>&nbsp;</P>
<P><IMG class="alignnone size-full wp-image-4466" alt="02 - one server detailed.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/02-one-server-detailed.png?resize=594%2C644&amp;ssl=1" width=594 height=644 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/02-one-server-detailed.png?fit=594%2C644&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/02-one-server-detailed.png?fit=277%2C300&amp;ssl=1" data-image-description="" data-image-title="02 ‚Äì one server detailed" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="594,644" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/02-one-server-detailed.png?fit=594%2C644&amp;ssl=1" data-permalink="https://blog.robsewell.com/getting-sqlservers-last-known-good-dbcc-checkdb-with-powershell-and-dbatools/02-one-server-detailed/#main" data-attachment-id="4466"></P>
<P>This time we get more information. The server name, database name, when the database was created, the last good DBCC Checkdb, how long since the database was created, how long since the last known good DBCC Checkdb, a status and a Data Purity enabled flag. If you look at the image above it shows that the DBA_Admin database has a status of ‚ÄúNew database, not checked yet‚Äù even though it has a date for the last known good DBCC CheckDb. This is because it was restored after this server was upgrade from CTP 1.3 to CTP 1.4 and there has not yet been a DBCC CheckDb run yet. The system databases have a status of ‚ÄúCheckDb should be performed‚Äù. This is because the last known good DBCC CheckDb is more than 7 days ago. Lets run a DBCC CheckDb and check again</P>
<P><IMG class="alignnone size-full wp-image-4474" alt="02a - one server.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/02a-one-server.png?resize=619%2C504&amp;ssl=1" width=619 height=504 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/02a-one-server.png?fit=619%2C504&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/02a-one-server.png?fit=300%2C244&amp;ssl=1" data-image-description="" data-image-title="02a ‚Äì one server" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="619,504" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/02a-one-server.png?fit=619%2C504&amp;ssl=1" data-permalink="https://blog.robsewell.com/getting-sqlservers-last-known-good-dbcc-checkdb-with-powershell-and-dbatools/02a-one-server/#main" data-attachment-id="4474"></P>
<P>This time the status has changed to OK for all of the databases üôÇ</P>
<P>We can pass an array of SQL servers to this command as well and check multiple servers at the same time. In this example, I am querying my Hyper-V server for all VMs with SQL in the name,except for my broken SQL2008 box ,that are running. I love PowerShell‚Äôs Out-GridView command for many reasons so lets use that. you can filter quickly and easily in the top bar.</P><PRE class="lang:ps decode:true">$SQLServers&nbsp;=&nbsp;(Get-VM&nbsp;-ComputerName&nbsp;beardnuc&nbsp;|&nbsp;Where-Object&nbsp;{$_.Name&nbsp;-like&nbsp;'*SQL*'&nbsp;-and&nbsp;$_.Name&nbsp;-ne&nbsp;'SQL2008Ser2008'&nbsp;-and&nbsp;$_.State&nbsp;-eq&nbsp;'Running'}).Name
Get-DbaLastGoodCheckDb -SqlServer $SQLServers -Detailed | Out-GridView</PRE>
<P><IMG class="alignnone size-full wp-image-4485" alt="03 - many servers ogv.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/03-many-servers-ogv.png?resize=630%2C311&amp;ssl=1" width=630 height=311 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/03-many-servers-ogv.png?fit=630%2C311&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/03-many-servers-ogv.png?fit=300%2C148&amp;ssl=1" data-image-description="" data-image-title="03 ‚Äì many servers ogv" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="1180,582" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/03-many-servers-ogv.png?fit=1180%2C582&amp;ssl=1" data-permalink="https://blog.robsewell.com/getting-sqlservers-last-known-good-dbcc-checkdb-with-powershell-and-dbatools/03-many-servers-ogv/#main" data-attachment-id="4485"></P>
<P>As you can see, you get a warning for secondary availability group databases. It‚Äôs quick too. In my lab of 10 servers and 125 databases ranging from SQL2005 to SQL vNext it runs in&nbsp;a little under &nbsp;5 seconds. This command is not compatible with SQL2000 servers.</P>
<P><IMG class="alignnone size-full wp-image-4490" alt="04 - measure comand.PNG" src="https://blog.robsewell.com/assets/uploads/2017/03/04-measure-comand.png?resize=630%2C442&amp;ssl=1" width=630 height=442 data-recalc-dims="1" loading="lazy" data-large-file="https://blog.robsewell.com/assets/uploads/2017/03/04-measure-comand.png?fit=630%2C442&amp;ssl=1" data-medium-file="https://blog.robsewell.com/assets/uploads/2017/03/04-measure-comand.png?fit=300%2C211&amp;ssl=1" data-image-description="" data-image-title="04 ‚Äì measure comand" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-comments-opened="1" data-orig-size="661,464" data-orig-file="https://blog.robsewell.com/assets/uploads/2017/03/04-measure-comand.png?fit=661%2C464&amp;ssl=1" data-permalink="https://blog.robsewell.com/getting-sqlservers-last-known-good-dbcc-checkdb-with-powershell-and-dbatools/04-measure-comand/#main" data-attachment-id="4490"></P>
<P>It is important to remember that as this script uses the DBCC DBINFO() WITH TABLERESULTS, there are&nbsp;several known weak points, including:</P>
<P>‚Äì DBCC DBINFO is an undocumented feature/command.<BR>‚Äì The LastKnowGood timestamp is updated when a DBCC CHECKFILEGROUP is performed.<BR>‚Äì The LastKnowGood timestamp is updated when a DBCC CHECKDB WITH PHYSICAL_ONLY is performed.<BR>‚Äì The LastKnownGood timestamp does not get updated when a database in READ_ONLY.</P>
<P>Databases created prior to SQL2005 and then upgraded to SQL 2005 or above need to have DBCC CheckDb run once with the DATA_PURITY option to ensure that the DATA_PURITY check ,which look for column values where the value is outside the valid range of values for the column‚Äôs data type, is run by default when DBCC CheckDB is run. This is explained more fully by Paul Randal <A href="http://www.sqlskills.com/blogs/paul/checkdb-from-every-angle-how-to-tell-if-data-purity-checks-will-be-run/" target=_blank>here</A>&nbsp;and Ken Simmons <A href="https://www.mssqltips.com/sqlservertip/1988/ensure-sql-server-data-purity-checks-are-performed/" target=_blank>here</A>&nbsp;The Data Purity Enabled flag from the command will show false if the data purity check is not being performed. This should be resolved by running DBCC CheckDB with DATA_PURITY option as explained <A href="https://www.mssqltips.com/sqlservertip/1119/sql-server-2005-dbcc-checkdb-with-datapurity-command/" target=_blank>here</A></P>
<P>Now with one line of PowerShell code you can check the last time a DBCC CheckDb was run for each database on one or more instances. The beauty of PowerShell is that an object is returned which you can use in any number of ways as <A href="https://blog.robsewell.com/taking-dbatools-test-dbalastbackup-a-little-further/" target=_blank>shown in a previous post</A></P>
<P>Happy Automating</P>
<P>NOTE ‚Äì The major 1.0 release of dbatools due in the summer 2017 may have breaking changes which will stop the above code from working. There are also new commands coming which may replace this command. This blog post was written using dbatools version 0.8.942 You can check your version using</P><PRE class="lang:ps decode:true">Get-Module dbatools</PRE>
<P>and update it using an Administrator PowerShell session with</P><PRE class="lang:ps decode:true">Update-Module dbatools</PRE>
<P>You may find that you get no output from Update-Module as you have the latest version. If&nbsp;you have not installed the&nbsp;module from the PowerShell Gallery using</P><PRE class="lang:ps decode:true">Install-Module dbatools</PRE>
<P>Then you can use</P><PRE class="lang:ps decode:true">Update-dbatools</PRE>
<P>&nbsp;</P>

